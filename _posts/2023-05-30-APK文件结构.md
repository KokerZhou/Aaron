---
layout:     post
title:      APK文件结构
subtitle:   对文件结构进行分析
date:       2023-5-30
author:     Aaron
header-img: img/post-bg-android.jpg
catalog: true
tags:
    - Rev
    - Android
---

### APK文件结构

APK是Android Package的缩写，即Android安装包，所有的Android程序都是以APK文件的形式发布的。可以在模拟器或手机上运行APK文件来安装程序。APK文件的后缀为．apk，但是其格式是压缩文件zip的格式。可以通过WinZip、WinRAR等将其解压



**简述版：**

- META-INF文件夹：签名文件目录
- res文件夹：资源库目录 一般存放xml布局文件和图标
- AndroidMainifest.xml ：配置清单（二进制格式）
- classes.dex：安卓系统上的可执行文件，也是我们逆向的主要的文件，源码都被编译在里面，如有多个是因为每个dex里最多存放65535个方法，而项目的方法数超出了这个数量，所以被分成多个保存
- resources.arsc：资源索引文件，包含语言包，汉化的话一般是反编译这个文件
- assets ：资源目录，一般存放图片
- lib：是动态库目录 一般存放so文件

![](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/watermark.png)

#### 1. **静态资源文件**

静态资源文件主要指存放在assets 文件夹中的文件。assets 文件夹是一种未经编译的资源目录，它会被打包进 APK 文件中，在安装应用程序之后可以被访问。assets 文件夹中的文件不会被解压缩，这意味着它们的访问速度会比较快，但是会占用更多的安装包空间。通常情况下，开发者会将应用程序中的静态文件、配置文件、原始数据或者其他不常改变的文件放在 assets 文件夹中。这样可以使得应用程序的下载包大小变小，并且可以更快速地访问这些文件。

#### 2.**库文件**

库文件主要指lib文件夹中的文件，在这个文件夹中，存放了运行APP所需要的so文件，也就是动态链接库的二进制文件。为了适配不同安卓系统处理器的版本，lib文件夹中的so库也是按不同处理器版本的文件夹分类放置。在图3的示例中，分成了三种文件夹包括armeabi、armeabi-v7a和x86文件夹，分别用来存储适配arm5架构、arm7架构、Intel32架构的CPU处理器版本的安卓系统。例如，如果智能手机使用的是arm7架构CPU处理器版本的安卓系统，APP在运行时就会调用armeabi-v7a文件夹下的动态链接库文件执行程序。

在安卓系统中库文件分文两种，一种是共享库文件（Shared Libraries），另一种是**本地库文件（Native Libraries）**。共享库文件是可供多个应用程序使用的库，它们被存放在系统目录中。在 Android 系统中，共享库文件以 .so 为后缀，常见的共享库文件包括 libc.so 和 libm.so。

而lib文件夹存放的就是本地库文件。本地库是专门为应用程序所使用的库，它们被打包进 APK 文件中，在安装应用程序之后会被放到私有目录中。在 Android 系统中，本地库文件也以 .so 为后缀。对于一个 Android 应用程序来说，本地库文件往往是应用程序所特有的，并且不会被其他应用程序使用。例如，**一个应用程序可能使用本地库文件来封装特定的硬件访问功能，或者使用本地库文件来进行加密解密操作。**

#### 3.签名文件

签名文件指的是存放在META-INF文件夹中的文件。META-INF 文件夹是 Android 系统中的一种特殊文件夹，它用来存放应用程序的签名信息。在 META-INF 文件夹中可以找到三种常见的文件：CERT.RSA、CERT.SF和MANIFEST.MF。CERT.RSA、CERT.SF这两个文件用来存放应用程序的签名信息。当安装一个应用程序时，Android 系统会检查这两个文件，以确保应用程序的完整性和安全性。MANIFEST.MF文件用来存放应用程序的所有文件的清单信息。

当打包应用程序时，这些文件会自动生成，并且会被打包进 APK 文件中。通常情况下，不需要手动修改这些文件，但是有时候可能需要编辑这些文件来更新应用程序的版本号或者修改权限要求。

META-INF文件夹，用于存放签名证书，在APK安装时作为校验的凭据，用于保护APK不被恶意篡改，同时也是对APK著作权和所有权的声名。例如，对安装包的任意文件最作修改，导致安卓系统检查计算后的签名信息与APK文件中存储的签名信息不一致，最终无法安装，会出现签名冲突的问题。

#### 4.编译资源文件

编译资源文件主要指存放在res文件夹中的文件。res文件夹，存放的也是资源文件，与assets文件夹不同的是，这里是编译后的资源文件。直接打开可能显示乱码。在 res 文件夹中你会找到许多子文件夹，每个子文件夹都用来存放特定类型的资源文件。主要的文件夹包括drawable 文件夹、layout 文件夹和values 文件夹。

drawable 文件夹用来存放图片资源文件，包括位图文件（.png, .jpg, .gif 等）和矢量图文件（.svg）。

layout 文件夹用来存放布局文件，布局文件用来描述应用程序的界面结构。

values 文件夹用来存放值资源文件，值资源文件用来存放应用程序中使用的常量值和颜色信息。

在 Android 系统中，所有的资源文件都必须在 res 文件夹中存放，并且需要使用特定的文件名和文件夹名。这样的好处是，Android 系统会自动为每个资源文件分配一个唯一的资源 ID，使得安卓系统可以方便地引用这些资源。

#### **5.配置清单文件**

AndroidManifest.xml文件是配置清单文件，也是编译过的文件，用来描述应用程序的清单信息。包括包名、应用名、权限、安卓四大组件、版本等重要信息都在这里面声名。

当打包应用程序时，AndroidManifest.xml 文件会自动生成，并且会被打包进 APK 文件中。当你安装应用程序时，Android 系统会读取这个文件，以确定应用程序的基本信息和权限要求。

开发者可以在 AndroidManifest.xml 文件中声明应用程序使用的权限，例如访问网络、访问文件、访问相机等。在应用程序安装时，用户会看到这些权限的描述信息，然后决定是否允许应用程序使用这些权限。

AndroidManifest.xml 文件还用来声明应用程序的主要组件，例如活动（Activity）、服务（Service）、广播接收器（BroadcastReceiver）等。这些组件是安卓应用程序的四大组件的组成部分，它们负责实现应用程序的功能

#### 6.核心代码文件

核心代码文件主要指classes.dex文件。classes.dex文件是 Android 系统中的重要代码文件，它是 Dalvik 可执行文件的缩写。Dalvik 是 Android 系统中的一种虚拟机，它负责在 Android 系统中运行应用程序的代码。classes.dex文件运行在Dalvik虚拟机上的核心代码文件，它反编译后的语言是smali代码语言，smali代码可转换为java代码。对于大的APK文件会出现多个dex文件，但在APP实际运行的过程中会将多个dex文件合并成一个dex文件运行。APK打包时存放多个dex的原因是每个dex文件的大小是有限制的。

.dex 文件中存放的是 Java 字节码，这是 Java 编译器编译出来的机器码。.dex 文件本身是一种二进制文件，它使用一种特殊的格式来存放字节码。

在打包 Android 应用程序时，.dex 文件会自动生成，并且会被打包进 APK 文件中。当你安装应用程序时，.dex 文件会被解压缩并放到私有目录中，然后被 Dalvik 虚拟机加载并运行。

.dex 文件的好处是，它可以使得应用程序的下载包大小变小，因为 Java 字节码文件可以被压缩得比较小。但是 .dex 文件的缺点是，它的访问速度略慢于共享库文件。因此，在 Android 系统中，一般情况下会尽量使用共享库文件来实现应用程序的功能。

#### 7.资源映射文件 

resources.arsc 文件是 Android 系统中的一种特殊文件，它用来存放应用程序的资源表。资源表是一种二进制文件，它包含了应用程序的资源 ID 和资源类型的映射关系。

在 Android 系统中，所有的资源文件都必须在 res 文件夹中存放，并且需要使用特定的文件名和文件夹名。当你编译应用程序时，编译器会将 res 文件夹中的资源文件编译成资源表，并且将资源表打包进 APK 文件中。

resources.arsc 文件的好处是，它可以使得应用程序的资源文件变小，因为资源表文件可以被压缩得比较小。但是，resources.arsc 文件的缺点是，它的访问速度略慢于普通的文本文件。因此，在 Android 系统中，一般情况下会尽量使用普通的文本文件来存放应用程序的资源信息。

注意，resources.arsc 文件仅仅是一个**辅助文件**，它本身并没有什么实际意义。应用程序通常是通过资源 ID在这个资源映射表中寻找对应的资源，来获取相应的参数。
